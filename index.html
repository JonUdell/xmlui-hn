<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="xmlui/0.9.11.js"></script>
    <script src="xmlui/charts-0.1.12.js"></script>
    <script src="xmlui/xmlui-devtools.js"></script>
    <script>
        window.xmluiHost = "http://hn.jonudell.info/xmlui-hn";

        window.mentions = function (names, days) {
            const jsonNames = JSON.stringify(names.split(",").map((n) => n.trim())); // Ensure valid JSON array

            const query = `
        WITH names AS (
            SELECT value AS name FROM json_each('${jsonNames}')
        ),
        counts AS (
            SELECT
                names.name,
                COUNT(*) AS mentions
            FROM hn
            JOIN names ON LOWER(hn.title) LIKE '%' || LOWER(names.name) || '%'
            WHERE
                time >= datetime('now', '-${days} days')
            GROUP BY names.name
        )
        SELECT name, mentions
        FROM counts
        WHERE mentions > 0 and name != ''
        ORDER BY mentions DESC;
    `;

            return query;
        };

        window.favorite = function (id, fave) {
            const query = "update hn set fave = " + fave + " where id = " + id;
            return { sql: query };
        };

        window.searchCombined = function (params = {}) {
            const {
                term = "",
                option = "all",
                start = getDefaultStartDate(), // today - 7 days
                end = getDefaultEndDate(), // today
                limit = 500,
            } = params;

            const whereClause = buildWhereClause(term, option, start, end);
            const query = buildQuery(whereClause, limit);
            return query;
        };

        function getDefaultEndDate() {
            return new Date().toISOString().slice(0, 10);
        }

        function getDefaultStartDate() {
            return new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                .toISOString()
                .slice(0, 10);
        }

        function buildWhereClause(term, option, start, end) {
            const conditions = [];

            if (term) {
                if (option === "undefined" || option === "all") {
                    conditions.push(`(title LIKE '%${term}%' OR url LIKE '%${term}%')`);
                } else {
                    conditions.push(`${option} LIKE '%${term}%'`);
                }
            }

            if (start && end) {
                const normalizedStart = start.replace(/\//g, "-");
                const normalizedEnd = end.replace(/\//g, "-");

                conditions.push(
                    `date(substr(time, 0, 11)) >= date('${normalizedStart}')` +
                    ` AND date(substr(time, 0, 11)) <= date('${normalizedEnd}') `
                );
            }

            return conditions.length > 0 ? "WHERE " + conditions.join(" AND ") : "";
        }

        function buildQuery(whereClause, limit) {
            const sql =
                `SELECT id, ` +
                `replace(substr(time, 0, 11), '-', '/') AS time, ` +
                `title, by, ` +
                `CAST(score AS integer) AS score, ` +
                `CAST(descendants AS integer) AS descendants, ` +
                `url, fave ` +
                `FROM hn ${whereClause} ` +
                `ORDER BY time DESC, CAST(score AS integer) DESC ` +
                `LIMIT ${limit}`;

            return JSON.stringify({ sql });
        }

        window.searchWrapper = function (start, end, term, option, limit) {
            return window.searchCombined({
                start: start,
                end: end,
                term: term,
                option: option,
                limit: limit,
            });
        };

        // Add this to your index.html script section
        window.queryCache = {};

        window.daysSources = function (domain, minDate, maxDate, forceRefresh = false) {
            const cacheKey = `${domain}-${minDate}-${maxDate}`;

            if (!forceRefresh && window.queryCache[cacheKey]) {
                console.log('Using cached query result for:', cacheKey);
                return window.queryCache[cacheKey];
            }

            console.log('Running new query for:', cacheKey);
            // If not in cache, generate the query
            const query = `
                with recursive dates(day) as (
                    select date('${minDate}')
                    union all
                    select date(day, '+1 day') from dates
                    where day < date('${maxDate}')
                ),
                items_by_day as (
                    select
                        date(substr(time, 1, 10)) as day,
                        substr(
                            url,
                            instr(url, '//') + 2,
                            instr(substr(url, instr(url, '//') + 2), '/') - 1
                        ) as domain
                    from hn
                    where url like 'http%://%/%'
                    and date(substr(time, 1, 10)) between date('${minDate}') and date('${maxDate}')
                ),
                counts as (
                    select
                        day,
                        count(*) as stories
                    from items_by_day
                    where domain = '${domain}'
                    group by day
                )
                select
                    dates.day,
                    coalesce(counts.stories, 0) as stories
                from
                    dates
                left join counts on dates.day = counts.day
                order by dates.day;
            `;

            // Store the result in cache
            const result = { sql: query };
            window.queryCache[cacheKey] = result;

            return result;
        };

        window.distinctSources = function () {
            const query = `
                select
                    domain,
                    count(*) as count
                from (
                    select
                        substr(
                            url,
                            instr(url, '//') + 2,
                            instr(substr(url, instr(url, '//') + 2), '/') - 1
                        ) as domain
                    from hn
                    where url like 'http%://%/%'
                )
                group by domain
                having count > 10
                order by domain;
        `
            return { sql: query }
        };


        window.mentionNames = {
            company:
                "amazon,amd,apple,cloudflare,facebook,google,ibm,intel,microsoft,mozilla,netflix,openai,tesla,tiktok,toshiba,twitter,sony,spacex,stripe,uber,zendesk,",
            language:
                "c#,clojure,css,erlang,golang,haskell,html,javascript,json,php,python,rust,sql,swift,typescript,webassembly,wasm,xml,",
            db: "clickhouse,citus,couchdb,db2,duckdb,mongodb,mysql,oracle,postgres,redis,sql server,timescale,sqlite,supabase,steampipe,yugabyte,",
        };
        window.sql = {
            stories: { sql: "select count(*) as value from hn" },
            days: {
                sql: "select count(distinct substr(time, 1, 10)) as value from hn",
            },
            askhn: {
                sql: "select count(*) as value from hn where title like '%Ask HN%'",
            },
            showhn: {
                sql: "select count(*) as value from hn where title like '%Show HN%'",
            },
            oldest: { sql: "select substr(min(time),0,11) as value from hn" },
            newest: { sql: "select substr(max(time),0,11) as value from hn" },
            maxscore: { sql: "select max(score) as value from hn" },
            companymentions7: {
                sql: window.mentions(window.mentionNames.company, 7),
            },
            companymentions30: {
                sql: window.mentions(window.mentionNames.company, 30),
            },
            companymentions90: {
                sql: window.mentions(window.mentionNames.company, 90),
            },
            languagementions7: {
                sql: window.mentions(window.mentionNames.language, 7),
            },
            languagementions30: {
                sql: window.mentions(window.mentionNames.language, 30),
            },
            languagementions90: {
                sql: window.mentions(window.mentionNames.language, 90),
            },
            dbmentions7: { sql: window.mentions(window.mentionNames.db, 7) },
            dbmentions30: { sql: window.mentions(window.mentionNames.db, 30) },
            dbmentions90: { sql: window.mentions(window.mentionNames.db, 90) },
        };
    </script>

    <script>
        const MS_PER_DAY = 86400 * 1000;

        const dateDiffInDays = (d1, d2) => Math.floor((d2 - d1) / MS_PER_DAY);

        window.minDate = new Date('2022-06-30');
        const now = new Date();
        window.maxDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        // Define date conversion functions first
        window.dateToSliderValue = function (date) {
            return dateDiffInDays(window.minDate, new Date(date));
        };

        window.sliderValueToDate = function (value) {
            return new Date(window.minDate.getTime() + value * MS_PER_DAY);
        };

        // Then calculate derived values
        const totalDays = dateDiffInDays(window.minDate, window.maxDate);
        window.totalRange = totalDays;

        window.initialEndValue = totalDays;
        window.initialStartValue = totalDays - 90;

        // Now use the functions after they're defined
        window.initialStartDate = window.sliderValueToDate(window.initialStartValue).toISOString().slice(0, 10);
        window.initialEndDate = window.sliderValueToDate(window.initialEndValue).toISOString().slice(0, 10);

        window.formatDate = (dateInput) => {
            // Convert to a proper Date object if it's a string
            const date = (typeof dateInput === 'string')
                ? new Date(dateInput)
                : dateInput;

            // Extract year, month, and day and format manually
            const year = date.getFullYear().toString().slice(-2); // Get last 2 digits of year
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-based
            const day = date.getDate().toString().padStart(2, '0');

            // Return in yy/mm/dd format
            return `${year}/${month}/${day}`;
        };
    </script>
</head>

<body></body>

</html>