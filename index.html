<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="xmlui/0.7.34.slider.js"></script>
    <script src="xmlui/charts-0.1.7.js"></script>
    <script>
        window.xmluiHost = 'http://hn.jonudell.info/xmlui-hn'

        /*
        window.recent = function (limit) {
            console.log('window.recent', limit)
            const query = "select id, replace(substr(time,0,11),'-','/') as time, title, by, cast(score as integer), cast(descendants as integer), url, fave from hn where url is not null order by time desc limit __LIMIT__ "
            return query.replace('__LIMIT__', limit)
        }
        */

        window.mentions = function (names, days) {
            const jsonNames = JSON.stringify(names.split(",").map(n => n.trim())); // Ensure valid JSON array

            const query = `
        WITH names AS (
            SELECT value AS name FROM json_each('${jsonNames}')
        ),
        counts AS (
            SELECT
                names.name,
                COUNT(*) AS mentions
            FROM hn
            JOIN names ON LOWER(hn.title) LIKE '%' || LOWER(names.name) || '%'
            WHERE
                time >= datetime('now', '-${days} days')
            GROUP BY names.name
        )
        SELECT name, mentions
        FROM counts
        WHERE mentions > 0 and name != ''
        ORDER BY mentions DESC;
    `;

            return query;
        };


        window.favorite = function (id, fave) {
            const query = "update hn set fave = " + fave + " where id = " + id
            return { "sql": query }
        }
        window.search = function (term, option) {

            // Default to empty string if term is undefined
            if (term === undefined) {
                term = "";
            }

            let whereClause = "";

            // Check if a term is provided (not empty)
            if (term !== "") {
                // Check what option is selected
                if (option === "undefined" || option === "all") {
                    // Search in all fields (you might want to specify which fields)
                    whereClause = "where title like '%" + term + "%' OR url like '%" + term + "%'";
                } else {
                    // Search in the specific field based on option
                    whereClause = "where " + option + " like '%" + term + "%'";
                }
            }

            const query = JSON.stringify({ "sql": "select id, replace(substr(time,0,11),'-','/') as time, title, by, cast(score as integer) as score, cast(descendants as integer) as descendants, url, fave from hn " + whereClause + " order by time desc, cast(score as integer) desc limit 5000" });
            //console.log({ whereClause, query });
            return query;
        }
        window.mentionNames = {
            "company": "amazon,amd,apple,cloudflare,facebook,ibm,intel,mozilla,netflix,openai,tesla,tiktok,toshiba,twitter,sony,spacex,stripe,uber,zendesk,",
            "language": "c#,clojure,css,erlang,golang,haskell,html,javascript,json,php,python,rust,sql,swift,typescript,webassembly,wasm,xml,",
            "db": "clickhouse,citus,couchdb,db2,duckdb,mongodb,mysql,oracle,postgres,redis,sql server,timescale,sqlite,supabase,steampipe,yugabyte,"
        }
        window.sql = {
            "stories": { "sql": "select count(*) as value from hn" },
            "days": { "sql": "select count(distinct substr(time, 1, 10)) as value from hn" },
            "askhn": { "sql": "select count(*) as value from hn where title like '%Ask HN%'" },
            "showhn": { "sql": "select count(*) as value from hn where title like '%Show HN%'" },
            "oldest": { "sql": "select substr(min(time),0,11) as value from hn" },
            "newest": { "sql": "select substr(max(time),0,11) as value from hn" },
            "maxscore": { "sql": "select max(score) as value from hn" },
            "companymentions7": { "sql": window.mentions(window.mentionNames.company, 7) },
            "companymentions30": { "sql": window.mentions(window.mentionNames.company, 30) },
            "companymentions90": { "sql": window.mentions(window.mentionNames.company, 90) },
            "languagementions7": { "sql": window.mentions(window.mentionNames.language, 7) },
            "languagementions30": { "sql": window.mentions(window.mentionNames.language, 30) },
            "languagementions90": { "sql": window.mentions(window.mentionNames.language, 90) },
            "dbmentions7": { "sql": window.mentions(window.mentionNames.db, 7) },
            "dbmentions30": { "sql": window.mentions(window.mentionNames.db, 30) },
            "dbmentions90": { "sql": window.mentions(window.mentionNames.db, 90) },
        }

    </script>
</head>

<body>
</body>

</html>