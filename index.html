<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="xmlui/0.7.29.js"></script>
    <script src="xmlui/xmlui-charts.js"></script>
    <script>
        window.xmluiHost = 'http://hn.jonudell.info/xmlui-hn'
        window.recent = function (limit) {
            const query = "select id, replace(substr(time,0,11),'-','/') as time, title, by, score, cast(descendants as integer) as descendants, url from hn where url is not null order by time desc limit __LIMIT__ "
            return query.replace('__LIMIT__', limit)
        }
        window.mentions = function (names, days) {
            const query = "WITH RECURSIVE names(name, remaining) AS ( SELECT '', '__NAMES__' UNION ALL SELECT substr(remaining, 1, instr(remaining, ',') - 1), substr(remaining, instr(remaining, ',') + 1) FROM names WHERE remaining != '' ), counts AS ( SELECT name, ( SELECT COUNT(*) FROM hn WHERE LOWER(title) LIKE '%' || LOWER(names.name) || '%' AND (julianday('now') - julianday(datetime(substr(time, 1, 19)))) * 24 * 60 BETWEEN 0 AND __DAYS__ *1440 AND time IS NOT NULL ) AS mentions FROM names WHERE name != '' ) SELECT name, mentions FROM counts WHERE mentions > 0 ORDER BY mentions DESC;".replace('__NAMES__', names).replace('__DAYS__', days)

            return query
        };
        window.favorite = function(id, fave) {
            const query = "update hn set fave = " + fave + " where id = " + id
            return { "sql": query }
        }
        window.search = function (term, option) {
            // console.log({ term, option });

            // Default to empty string if term is undefined
            if (term === undefined) {
                term = "";
            }

            let whereClause = "";

            // Check if a term is provided (not empty)
            if (term !== "") {
                // Check what option is selected
                if (option === "undefined" || option === "all") {
                    // Search in all fields (you might want to specify which fields)
                    whereClause = "where title like '%" + term + "%' OR url like '%" + term + "%'";
                } else {
                    // Search in the specific field based on option
                    whereClause = "where " + option + " like '%" + term + "%'";
                }
            }

            const query = JSON.stringify({ "sql": "select id, replace(substr(time,0,11),'-','/') as time, title, by, score, cast(descendants as integer) as descendants, url, fave from hn " + whereClause + " order by time desc limit 5000" });
            //console.log({ whereClause, query });
            return query;
        }
        window.mentionNames = {
            "company": "amazon,amd,apple,cloudflare,facebook,ibm,intel,mozilla,netflix,openai,tesla,tiktok,toshiba,twitter,sony,spacex,stripe,uber,zendesk,",
            "language": "c#,clojure,css,erlang,golang,haskell,html,javascript,json,php,python,rust,sql,swift,typescript,webassembly,wasm,xml,",
            "db": "clickhouse,citus,couchdb,db2,duckdb,mongodb,mysql,oracle,postgres,redis,sql server,timescale,sqlite,supabase,steampipe,yugabyte,"
        }
        window.sql = {
            "stories": { "sql": "select count(*) as value from hn" },
            "days": { "sql": "select count(distinct substr(time, 1, 10)) as value from hn" },
            "askhn": { "sql": "select count(*) as value from hn where title like '%Ask HN%'" },
            "showhn": { "sql": "select count(*) as value from hn where title like '%Show HN%'" },
            "oldest": { "sql": "select substr(min(time),0,11) as value from hn" },
            "newest": { "sql": "select substr(max(time),0,11) as value from hn" },
            "maxscore": { "sql": "select max(score) as value from hn" },
            "companymentions7": { "sql": window.mentions(window.mentionNames.company, 7) },
            "companymentions30": { "sql": window.mentions(window.mentionNames.company, 30) },
            "companymentions90": { "sql": window.mentions(window.mentionNames.company, 90) },
            "languagementions7": { "sql": window.mentions(window.mentionNames.language, 7) },
            "languagementions30": { "sql": window.mentions(window.mentionNames.language, 30) },
            "languagementions90": { "sql": window.mentions(window.mentionNames.language, 90) },
            "dbmentions7": { "sql": window.mentions(window.mentionNames.db, 7) },
            "dbmentions30": { "sql": window.mentions(window.mentionNames.db, 30) },
            "dbmentions90": { "sql": window.mentions(window.mentionNames.db, 90) },
            "recent50": { "sql": window.recent(50) },
            "recent1000": { "sql": window.recent(1000) },
        }
    </script>
</head>

<body>
</body>

</html>
